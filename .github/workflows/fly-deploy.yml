name: Deploy to Fly.io

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize, closed]

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  # Set these to your Fly.io organization and preferred region
  FLY_REGION: iad
  FLY_ORG: personal

jobs:
  deploy-production:
    name: Deploy to production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    concurrency: deploy-group
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: |
          flyctl scale count 0 --yes || true
          flyctl deploy --remote-only --ha=false

  review_app:
    name: Deploy review app
    runs-on: ubuntu-latest
    # Only run for PRs, not main branch pushes
    if: github.event_name == 'pull_request'
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    # Only run one deployment at a time per PR
    concurrency:
      group: pr-${{ github.event.number }}
    # The "review" environment allows the URL to be displayed in the PR UI
    environment:
      name: review
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Get code
        uses: actions/checkout@v4

      - name: Set lowercase app name
        id: app-name
        run: |
          # Convert username to lowercase for Fly.io compatibility
          ACTOR_LOWER=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2 | tr '[:upper:]' '[:lower:]')
          APP_NAME="pr-${{ github.event.number }}-${ACTOR_LOWER}-${REPO_NAME}"
          echo "app_name=${APP_NAME}" >> $GITHUB_OUTPUT
          echo "Generated app name: ${APP_NAME}"

      - name: Use review app config
        run: cp fly.review.toml fly.toml

      - name: Deploy PR app to Fly.io
        id: deploy
        uses: superfly/fly-pr-review-apps@1.2.1
        with:
          name: ${{ steps.app-name.outputs.app_name }}
          secrets: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            OPENCAGE_API_KEY=${{ secrets.OPENCAGE_API_KEY }}
            NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
            FROM_EMAIL=${{ secrets.FROM_EMAIL }}
            NEXT_PUBLIC_CALCULOS_API_URL=${{ secrets.NEXT_PUBLIC_CALCULOS_API_URL }}
            NEXT_PUBLIC_INTERPRETACIONES_API_URL=${{ secrets.NEXT_PUBLIC_INTERPRETACIONES_API_URL }}
            NEXT_PUBLIC_CALENDARIO_API_URL=${{ secrets.NEXT_PUBLIC_CALENDARIO_API_URL }}
            NEXT_PUBLIC_ASTROGEMATRIA_API_URL=${{ secrets.NEXT_PUBLIC_ASTROGEMATRIA_API_URL }}
            NEXT_PUBLIC_CARTA_ELECTIVA_API_URL=${{ secrets.NEXT_PUBLIC_CARTA_ELECTIVA_API_URL }}

  cleanup_review_app:
    name: Cleanup review app
    runs-on: ubuntu-latest
    # Only run when PR is closed (merged or closed without merge)
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    steps:
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Set app name for cleanup
        id: app-name
        run: |
          ACTOR_LOWER=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2 | tr '[:upper:]' '[:lower:]')
          APP_NAME="pr-${{ github.event.number }}-${ACTOR_LOWER}-${REPO_NAME}"
          echo "app_name=${APP_NAME}" >> $GITHUB_OUTPUT
          echo "Cleaning up app: ${APP_NAME}"

      - name: Delete review app
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"
          if flyctl apps list | grep -q "^${APP_NAME}"; then
            echo "Deleting app: ${APP_NAME}"
            flyctl apps delete -y "${APP_NAME}"
          else
            echo "App ${APP_NAME} not found, skipping deletion"
          fi
