name: Deploy to Fly.io

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize, closed]

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  # Set these to your Fly.io organization and preferred region
  FLY_REGION: iad
  FLY_ORG: personal

jobs:
  deploy-production:
    name: Deploy to production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    concurrency: deploy-group
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: |
          flyctl scale count 0 --yes || true
          flyctl deploy --remote-only --ha=false

  review_app:
    name: Deploy review app
    runs-on: ubuntu-latest
    # Only run for PRs, not main branch pushes
    if: github.event_name == 'pull_request'
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    # Only run one deployment at a time per PR
    concurrency:
      group: pr-${{ github.event.number }}
    # The "review" environment allows the URL to be displayed in the PR UI
    environment:
      name: review
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Get code
        uses: actions/checkout@v4

      - name: Set lowercase app name
        id: app-name
        run: |
          # Convert username to lowercase for Fly.io compatibility
          ACTOR_LOWER=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2 | tr '[:upper:]' '[:lower:]')
          APP_NAME="pr-${{ github.event.number }}-${ACTOR_LOWER}-${REPO_NAME}"
          echo "app_name=${APP_NAME}" >> $GITHUB_OUTPUT
          echo "Generated app name: ${APP_NAME}"

      - name: Deploy PR app to Fly.io
        id: deploy
        uses: superfly/fly-pr-review-apps@1.2.1
        with:
          name: ${{ steps.app-name.outputs.app_name }}
